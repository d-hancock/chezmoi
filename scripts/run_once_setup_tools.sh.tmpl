#!/usr/bin/env bash
# ===================================================================
# ChezMoi Bootstrap Script - Tool Installation
# ===================================================================
# This script runs once when ChezMoi is first applied
# It installs Pixi package manager and synchronizes all CLI tools
# defined in pixi.toml, plus fallback installations for tools
# not available in conda-forge
# 
# Execution: Automatically run by ChezMoi on first 'chezmoi apply'
# Template: This is a .tmpl file, so it can use ChezMoi variables

set -e  # Exit on any error

echo "🚀 Setting up development tools..."

# ===================================================================
# Pixi Installation
# ===================================================================
# Install Pixi if it's not already available
# Pixi manages most of our CLI tools via conda-forge ecosystem
if ! command -v pixi >/dev/null; then
  echo "📦 Installing Pixi package manager..."
  curl -sSf https://pixi.sh/install.sh | bash
  echo "✅ Pixi installed successfully"
else
  echo "✅ Pixi already installed"
fi

# ===================================================================
# ChezMoi Binary Setup
# ===================================================================
# Ensure chezmoi is accessible in PATH by creating symlink
echo "🔗 Setting up ChezMoi binary access..."

# Create .local/bin directory if it doesn't exist
mkdir -p "$HOME/.local/bin"

# Path to chezmoi binary in source directory
# Use CHEZMOI_SOURCE_DIR if available (set by chezmoi during execution)
# Otherwise fall back to the current script's parent directory
if [[ -n "${CHEZMOI_SOURCE_DIR:-}" ]]; then
    CHEZMOI_BINARY="${CHEZMOI_SOURCE_DIR}/bin/chezmoi"
else
    # Get the source directory from the script's location
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    CHEZMOI_SOURCE_DIR="$(dirname "$SCRIPT_DIR")"
    CHEZMOI_BINARY="${CHEZMOI_SOURCE_DIR}/bin/chezmoi"
fi

# Check if binary exists
if [[ -f "$CHEZMOI_BINARY" ]]; then
    # Make sure the binary is executable
    chmod +x "$CHEZMOI_BINARY"
    
    # Create or update symlink
    if [[ -L "$HOME/.local/bin/chezmoi" ]]; then
        # Remove existing symlink
        rm "$HOME/.local/bin/chezmoi"
    elif [[ -f "$HOME/.local/bin/chezmoi" ]]; then
        # Backup existing file
        mv "$HOME/.local/bin/chezmoi" "$HOME/.local/bin/chezmoi.backup.$(date +%s)"
        echo "⚠️  Backed up existing chezmoi binary"
    fi
    
    # Create new symlink
    ln -sf "$CHEZMOI_BINARY" "$HOME/.local/bin/chezmoi"
    echo "✅ ChezMoi binary linked to PATH"
    
    # Verify it works
    if command -v chezmoi >/dev/null 2>&1; then
        echo "✅ ChezMoi is now accessible via PATH"
    else
        echo "❌ ChezMoi setup failed - still not in PATH"
    fi
else
    echo "❌ ChezMoi binary not found at $CHEZMOI_BINARY"
fi

# ===================================================================
# Environment Setup
# ===================================================================
# Ensure Pixi is available in current session
export PATH="$HOME/.pixi/bin:$PATH"

# ===================================================================
# Package Synchronization
# ===================================================================
# Navigate to ChezMoi source directory and sync packages using profiles
echo "📋 Synchronizing packages from pixi.toml..."
# Use the source directory we already determined
cd "${CHEZMOI_SOURCE_DIR}"

# Install development profile (includes default + dev tools automatically)
echo "🛠️  Installing development tools (includes default tools)..."
pixi install --environment dev

echo "✅ Pixi packages synchronized"

# ===================================================================
# Fallback Installations
# ===================================================================
# Install tools not available in conda-forge or having platform issues
# These are essential for our ZSH configuration and daily workflow

echo "🔧 Installing fallback tools via system package manager..."

# Detect the environment
PLATFORM="unknown"
if [[ "$(uname)" == "Linux" ]]; then
    if grep -qi microsoft /proc/version 2>/dev/null; then
        PLATFORM="wsl2"
        echo "🪟 Detected WSL2 environment"
    else
        PLATFORM="linux"
        echo "🐧 Detected Linux environment"
    fi
else
    echo "❌ Unsupported platform: $(uname)"
    exit 1
fi

# Detect package manager
if command -v apt-get >/dev/null; then
    PACKAGE_MANAGER="apt"
elif command -v yum >/dev/null; then
    PACKAGE_MANAGER="yum"
elif command -v dnf >/dev/null; then
    PACKAGE_MANAGER="dnf"
else
    echo "⚠️  No supported package manager found, skipping fallback installations"
    PACKAGE_MANAGER="none"
fi

# Function to install tools with better error handling and permission fixes
install_fallback_tool() {
    local tool="$1"
    local apt_package="$2"
    local binary_check="${3:-$tool}"
    
    if command -v "$binary_check" >/dev/null 2>&1; then
        echo "✅ $tool already available"
        # Ensure existing tool has execute permissions
        tool_path=$(which "$binary_check" 2>/dev/null)
        if [[ -n "$tool_path" && -f "$tool_path" && ! -x "$tool_path" ]]; then
            echo "🔧 Fixing permissions for $tool..."
            chmod +x "$tool_path" 2>/dev/null || echo "⚠️  Cannot fix permissions for $tool"
        fi
        return 0
    fi
    
    echo "📦 Installing $tool ($apt_package)..."
    case "$PACKAGE_MANAGER" in
        "apt")
            sudo apt-get update -qq >/dev/null 2>&1 || true
            if sudo apt-get install -y "$apt_package" >/dev/null 2>&1; then
                echo "✅ Successfully installed $tool"
                # Fix permissions for newly installed tool
                tool_path=$(which "$binary_check" 2>/dev/null)
                if [[ -n "$tool_path" && -f "$tool_path" ]]; then
                    chmod +x "$tool_path" 2>/dev/null || true
                fi
            else
                echo "❌ Failed to install $tool via apt"
                return 1
            fi
            ;;
        "dnf")
            if sudo dnf install -y "$apt_package" >/dev/null 2>&1; then
                echo "✅ Successfully installed $tool"
                # Fix permissions for newly installed tool
                tool_path=$(which "$binary_check" 2>/dev/null)
                if [[ -n "$tool_path" && -f "$tool_path" ]]; then
                    chmod +x "$tool_path" 2>/dev/null || true
                fi
            else
                echo "❌ Failed to install $tool via dnf"
                return 1
            fi
            ;;
        "yum")
            if sudo yum install -y "$apt_package" >/dev/null 2>&1; then
                echo "✅ Successfully installed $tool"
                # Fix permissions for newly installed tool
                tool_path=$(which "$binary_check" 2>/dev/null)
                if [[ -n "$tool_path" && -f "$tool_path" ]]; then
                    chmod +x "$tool_path" 2>/dev/null || true
                fi
            else
                echo "❌ Failed to install $tool via yum"
                return 1
            fi
            ;;
        *)
            echo "⚠️  Cannot install $tool - no supported package manager"
            return 1
            ;;
    esac
}

# Essential tools for ZSH configuration that commonly have conda-forge issues
echo "🔧 Installing critical tools that may not be available via Pixi..."

# Core tools needed for ZSH config
install_fallback_tool "bat" "bat" || echo "⚠️  bat installation failed, continuing..."
install_fallback_tool "fzf" "fzf" || echo "⚠️  fzf installation failed, continuing..."
install_fallback_tool "ripgrep" "ripgrep" "rg" || echo "⚠️  ripgrep installation failed, continuing..."
install_fallback_tool "fd-find" "fd-find" "fd" || echo "⚠️  fd-find installation failed, continuing..."

# Handle fd-find symlink issue on Ubuntu/Debian
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
    echo "🔗 Creating fd symlink for fdfind..."
    mkdir -p "$HOME/.local/bin"
    ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
    echo "✅ fd symlink created"
fi

# Additional modern CLI tools
install_fallback_tool "eza" "eza"
install_fallback_tool "btop" "btop"

# Install platform-specific tools
if [[ "$PLATFORM" == "wsl2" ]]; then
    echo "🪟 Installing WSL2-specific tools..."
    install_fallback_tool "wslu" "wslu"
elif [[ "$PLATFORM" == "linux" ]]; then
    echo "🐧 Installing Linux-specific tools..."
    install_fallback_tool "xclip" "xclip"
    install_fallback_tool "wl-clipboard" "wl-clipboard" "wl-copy"
fi

# Install development tools that are essential
echo "🛠️  Installing essential development tools..."
install_fallback_tool "git" "git"
install_fallback_tool "curl" "curl"
install_fallback_tool "wget" "wget"
install_fallback_tool "unzip" "unzip"
install_fallback_tool "jq" "jq"

# Install build tools for potential compilation needs
if [[ "$PACKAGE_MANAGER" == "apt" ]]; then
    install_fallback_tool "build-essential" "build-essential" "gcc"
fi

echo "✅ Fallback tools installation complete"

# ===================================================================
# POST-INSTALLATION VERIFICATION & PERMISSIONS
# ===================================================================
echo "🔍 Verifying critical tools and fixing permissions..."

CRITICAL_TOOLS=("bat" "fzf" "rg" "fd" "git" "jq" "chezmoi")
MISSING_TOOLS=()

for tool in "${CRITICAL_TOOLS[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
        echo "✅ $tool: available"
        
        # Ensure the tool has execute permissions
        tool_path=$(which "$tool" 2>/dev/null)
        if [[ -n "$tool_path" && -f "$tool_path" ]]; then
            if [[ ! -x "$tool_path" ]]; then
                echo "🔧 Fixing permissions for $tool..."
                chmod +x "$tool_path" 2>/dev/null || {
                    echo "⚠️  Cannot fix permissions for $tool (may need sudo)"
                }
            fi
        fi
    else
        echo "❌ $tool: missing"
        MISSING_TOOLS+=("$tool")
    fi
done

# Fix permissions for any user binaries in ~/.local/bin
if [[ -d "$HOME/.local/bin" ]]; then
    echo "🔧 Ensuring all user binaries have execute permissions..."
    find "$HOME/.local/bin" -type f -name "*" -exec chmod +x {} \; 2>/dev/null || true
fi

# Fix permissions for Pixi-managed tools
if [[ -d "$HOME/.pixi/bin" ]]; then
    echo "🔧 Ensuring Pixi-managed tools have execute permissions..."
    find "$HOME/.pixi/bin" -type f -name "*" -exec chmod +x {} \; 2>/dev/null || true
fi

if [[ ${#MISSING_TOOLS[@]} -gt 0 ]]; then
    echo ""
    echo "⚠️  Some critical tools are missing: ${MISSING_TOOLS[*]}"
    echo "💡 Your ZSH configuration may have errors until these are installed"
    echo "   Try: sudo apt install ${MISSING_TOOLS[*]}"
fi

echo "🎉 Tool setup complete!"
