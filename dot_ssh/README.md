# SSH Configuration Directory (dot_ssh)

## Overview

This directory contains SSH client configuration and key management templates that will be placed in `~/.ssh/` by ChezMoi. It provides platform-aware SSH setup with automatic key generation and secure configuration.

### Role in the Project

The `dot_ssh` directory handles:
- **SSH Configuration**: Platform-aware SSH client settings
- **Key Management**: Automatic SSH key generation for different platforms
- **Security**: Proper file permissions and secure defaults
- **Integration**: Git hosting service compatibility (GitHub, GitLab)

### Platform Support

- **Linux**: Uses `id_ed25519` key pair
- **Windows**: Uses `id_ed25519_win` key pair  
- **WSL**: Detected and uses Linux key naming
- **Cross-Platform**: Shared SSH config with platform-specific sections

---

## Directory Structure

### `config.tmpl` - SSH Client Configuration
- **Purpose**: Platform-aware SSH client settings
- **Features**: Security defaults, connection multiplexing, host-specific settings
- **Template Logic**: Different key files based on platform detection
- **Integration**: Works with modern SSH clients and security best practices

### Key Management (Generated by Script)
- **`id_ed25519`**: Linux/WSL SSH private key (generated, not in repo)
- **`id_ed25519.pub`**: Linux/WSL SSH public key (safe to commit after generation)
- **`id_ed25519_win`**: Windows SSH private key (generated, not in repo)
- **`id_ed25519_win.pub`**: Windows SSH public key (safe to commit after generation)

---

## SSH Setup Process

### Automatic Key Generation
The `run_once_setup_ssh_keys.sh.tmpl` script handles:

1. **Directory Creation**: Creates `~/.ssh` with proper permissions (700)
2. **Key Generation**: Creates Ed25519 keys if they don't exist
3. **Permission Setting**: Applies strict SSH file permissions
4. **SSH Agent**: Configures and starts SSH agent
5. **Key Loading**: Adds keys to SSH agent automatically

### Security Features

#### File Permissions
- SSH directory: `700` (owner access only)
- Private keys: `600` (owner read/write only)
- Public keys: `644` (owner read/write, others read)
- Config file: `600` (owner read/write only)

#### SSH Configuration Security
- Protocol 2 only (more secure)
- Modern key exchange algorithms
- Strong ciphers and MACs
- Host key verification
- Connection multiplexing for performance

---

## Integration with Other Components

### Shell Integration (Zsh)
- **SSH Agent**: Auto-started in `dot_zshrc.tmpl`
- **Key Loading**: Automatic key addition to agent
- **Session Management**: Persistent SSH agent across shell sessions

### Git Integration
- **GitHub/GitLab**: Pre-configured host entries
- **Git Config**: Template supports SSH URL rewriting
- **Authentication**: Seamless Git operations with SSH keys

### ChezMoi Integration
- **Templates**: Platform detection and conditional configuration
- **Secrets**: Private keys handled securely (not committed)
- **Automation**: One-time setup script for key generation

---

## Usage Examples

### Adding New SSH Hosts
Edit `config.tmpl` to add new hosts:

```ssh
Host myserver
  HostName server.example.com
  User username
  Port 2222
  {{- if $isWindows }}
  IdentityFile ~/.ssh/id_ed25519_win
  {{- else }}
  IdentityFile ~/.ssh/id_ed25519
  {{- end }}
```

### Copying Public Key
After setup, copy your public key:

```bash
# Linux/WSL
cat ~/.ssh/id_ed25519.pub | xclip -selection clipboard

# Windows
cat ~/.ssh/id_ed25519_win.pub | clip

# Manual copy
cat ~/.ssh/id_ed25519*.pub
```

### Adding to Git Hosting Services
1. **GitHub**: Settings → SSH and GPG keys → New SSH key
2. **GitLab**: Profile → SSH Keys → Add key
3. **Others**: Check documentation for SSH key management

---

## Security Best Practices

### Key Management
- **Ed25519 Keys**: Modern, secure, fast algorithm
- **Unique Keys**: Separate keys per platform if needed
- **Passphrases**: Consider adding passphrases for extra security
- **Key Rotation**: Regularly rotate keys for high-security environments

### SSH Agent Security
- **Agent Forwarding**: Be cautious with `ForwardAgent` on untrusted hosts
- **Key Timeouts**: Consider setting key lifetime limits
- **Screen Lock**: Ensure workstation locks when unattended

### Configuration Security
- **StrictHostKeyChecking**: Enabled for unknown hosts
- **Host Verification**: DNS verification enabled
- **Connection Limits**: Timeouts and keep-alive configured

---

## Troubleshooting

### Common Issues

#### Permission Denied
```bash
# Fix SSH directory permissions
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519*
chmod 644 ~/.ssh/id_ed25519*.pub
chmod 600 ~/.ssh/config
```

#### SSH Agent Not Running
```bash
# Check SSH agent
echo $SSH_AUTH_SOCK

# Start SSH agent manually
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519*
```

#### Git Authentication Fails
```bash
# Test SSH connection to GitHub
ssh -T git@github.com

# Check SSH key is loaded
ssh-add -l

# Verify SSH config
ssh -F ~/.ssh/config -T git@github.com
```

### Advanced Configuration

#### Connection Multiplexing
The configuration enables SSH connection multiplexing for better performance:
- Multiple sessions share single connection
- Faster subsequent connections
- Reduced authentication overhead

#### Jump Hosts
For complex network setups with bastion hosts:

```ssh
Host bastion
  HostName bastion.example.com
  User jumpuser

Host internal
  HostName internal.local
  User devuser
  ProxyJump bastion
```

This SSH configuration provides a secure, automated, and cross-platform foundation for your development environment!
